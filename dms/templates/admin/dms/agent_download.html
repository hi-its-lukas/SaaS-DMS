{% extends "admin/base_site.html" %}
{% load i18n %}

{% block content %}
<div style="max-width: 900px; margin: 0 auto; padding: 20px;">
    <div style="background: linear-gradient(135deg, #007e45 0%, #005c32 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
        <h1 style="margin: 0 0 10px 0; font-size: 28px;">
            <span style="margin-right: 10px;">üì¶</span>
            DMS Sync Agent Download
        </h1>
        <p style="margin: 0; opacity: 0.9;">
            Laden Sie den vorkonfigurierten Agent f√ºr Ihre Kunden herunter.
        </p>
    </div>

    {% if agent_available %}
    <div style="background: #d4edda; border: 1px solid #28a745; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong style="color: #155724;">‚úÖ Agent-Binary verf√ºgbar</strong>
        <p style="margin: 5px 0 0 0; color: #155724;">
            Version: {{ agent_version }} | Gr√∂√üe: {{ agent_size|filesizeformat }}
        </p>
    </div>
    {% else %}
    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong style="color: #856404;">‚ö†Ô∏è Agent-Binary nicht hochgeladen</strong>
        <p style="margin: 5px 0 0 0; color: #856404;">
            Die ZIP-Downloads enthalten einen Platzhalter. Bitte laden Sie die kompilierte EXE hoch.
        </p>
        <form method="post" action="{% url 'dms_agent_upload' %}" enctype="multipart/form-data" style="margin-top: 10px;">
            {% csrf_token %}
            <input type="file" name="agent_exe" accept=".exe" required style="margin-right: 10px;">
            <input type="text" name="version" placeholder="Version (z.B. 1.0.0)" style="padding: 5px; margin-right: 10px; width: 120px;">
            <button type="submit" style="background: #007e45; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                Hochladen
            </button>
        </form>
    </div>
    {% endif %}

    <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
        <h3 style="margin-top: 0;">‚ÑπÔ∏è Was ist der DMS Sync Agent?</h3>
        <p>Der DMS Sync Agent ist ein Windows-Dienst, der auf dem Server Ihres Kunden installiert wird. Er √ºberwacht lokale Exportordner und l√§dt neue Dokumente automatisch in das DMS hoch.</p>
        
        <h4>Funktionen:</h4>
        <ul>
            <li><strong>Ordner-√úberwachung:</strong> Erkennt neue Dateien automatisch</li>
            <li><strong>Sichere √úbertragung:</strong> Verschl√ºsselte HTTPS-Verbindung</li>
            <li><strong>Offline-Queue:</strong> Puffert bei Netzwerkproblemen</li>
            <li><strong>Windows-Dienst:</strong> L√§uft automatisch im Hintergrund</li>
        </ul>
    </div>

    <h2>Mandanten mit Mandanten-Code</h2>
    <p>W√§hlen Sie einen Mandanten, um den vorkonfigurierten Agent herunterzuladen:</p>

    {% if tenants %}
    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <thead>
            <tr style="background: #007e45; color: white;">
                <th style="padding: 12px 15px; text-align: left;">Mandant</th>
                <th style="padding: 12px 15px; text-align: left;">Unternehmen</th>
                <th style="padding: 12px 15px; text-align: left;">Code</th>
                <th style="padding: 12px 15px; text-align: left;">Agent-Status</th>
                <th style="padding: 12px 15px; text-align: center;">Download</th>
            </tr>
        </thead>
        <tbody>
            {% for tenant in tenants %}
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 12px 15px;">
                    <strong>{{ tenant.name }}</strong>
                </td>
                <td style="padding: 12px 15px;">
                    {% if tenant.company %}{{ tenant.company.name }}{% else %}-{% endif %}
                </td>
                <td style="padding: 12px 15px;">
                    <code style="background: #e9ecef; padding: 2px 6px; border-radius: 4px;">{{ tenant.code }}</code>
                </td>
                <td style="padding: 12px 15px;">
                    {% if tenant.agent_last_seen %}
                        {% load tz %}
                        {% now "U" as now_timestamp %}
                        {% widthratio tenant.agent_last_seen|date:"U" 1 1 as last_seen_timestamp %}
                        <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                            üü¢ Online
                        </span>
                        <br><small style="color: #666;">v{{ tenant.agent_version }}</small>
                    {% else %}
                        <span style="background: #6c757d; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                            ‚ö™ Nicht installiert
                        </span>
                    {% endif %}
                </td>
                <td style="padding: 12px 15px; text-align: center;">
                    <a href="{% url 'dms_agent_download_zip' tenant.id %}" 
                       style="display: inline-block; background: #007e45; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 500;">
                        ‚¨áÔ∏è ZIP herunterladen
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 20px; border-radius: 8px; text-align: center;">
        <p style="margin: 0;">
            <strong>Keine Mandanten mit Code gefunden.</strong><br>
            Mandanten ben√∂tigen einen Code, um den Agent nutzen zu k√∂nnen.
        </p>
    </div>
    {% endif %}

    <div style="margin-top: 30px; padding: 20px; background: #e7f5ff; border-radius: 8px; border-left: 4px solid #007e45;">
        <h4 style="margin-top: 0;">üîß F√ºr Entwickler: Agent selbst kompilieren</h4>
        <p>Der Agent-Quellcode befindet sich im Ordner <code>dms-sync-agent/</code>.</p>
        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; overflow-x: auto;">
# F√ºr Windows (Cross-Compile von Linux):
cd dms-sync-agent
GOOS=windows GOARCH=amd64 go build -o DMSSyncAgent.exe ./cmd/agent

# Dann hier hochladen oder via Azure CLI:
az storage blob upload \
  --container-name system \
  --name agent-binaries/DMSSyncAgent.exe \
  --file DMSSyncAgent.exe \
  --metadata version=1.0.0</pre>
    </div>
</div>
{% endblock %}
