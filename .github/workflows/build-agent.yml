name: Build DMS Sync Agent

on:
  push:
    paths:
      - 'dms-sync-agent/**'
    tags:
      - 'agent-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  GO_VERSION: '1.22'

jobs:
  build-windows:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: dms-sync-agent/go.sum

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/agent-v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/agent-v}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Build for Windows (amd64)
        working-directory: dms-sync-agent
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w -X main.Version=${{ steps.version.outputs.version }}" \
            -o ../DMSSyncAgent.exe ./cmd/agent

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DMSSyncAgent-${{ steps.version.outputs.version }}
          path: DMSSyncAgent.exe
          retention-days: 90

      - name: Upload to Azure Blob Storage
        if: startsWith(github.ref, 'refs/tags/agent-v') || github.event_name == 'workflow_dispatch'
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az storage blob upload \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
              --container-name system \
              --name agent-binaries/DMSSyncAgent.exe \
              --file DMSSyncAgent.exe \
              --overwrite \
              --metadata version=${{ steps.version.outputs.version }} \
              --auth-mode key \
              --account-key ${{ secrets.AZURE_STORAGE_KEY }}
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/agent-v')
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: DMSSyncAgent-${{ needs.build-windows.outputs.version }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: DMSSyncAgent.exe
          generate_release_notes: true
