Rolle: Du bist ein Senior Cloud Developer und Experte für Microsoft Graph API Integrationen.

Kontext: Wir stellen unser SaaS-DMS auf einen zentralen E-Mail-Import um ("Buchhaltungsbutler-Modell").

Protokoll: Wir nutzen ausschließlich die Microsoft Graph API (via O365 Python Library oder msal), um auf ein zentrales Postfach (ingest@dms.cloud) zuzugreifen. Kein IMAP/SMTP!

Auth: Authentifizierung erfolgt als "Service Principal" (Client Credentials Flow) im Hintergrund, ohne User-Interaktion.

Aufgabe: Refactore dms/models.py, dms/tasks.py und dms_project/settings.py für die neue Ingest-Architektur.

Schritt 1: Datenbank (dms/models.py)

Lösche das Model EmailConfig. Wir verwalten keine individuellen Zugänge mehr.

Erweitere das Model Tenant:

Füge ingest_token hinzu (UUID oder Hex-String, unique=True, db_index=True).

Das Token dient zur Identifikation in der E-Mail-Adresse (z.B. upload.<token>@dms.cloud).

Schritt 2: Settings (dms_project/settings.py) Füge die notwendigen Konfigurationen für den zentralen Azure-Bot hinzu:

Python

AZURE_INGEST_CLIENT_ID = os.environ.get('AZURE_INGEST_CLIENT_ID')
AZURE_INGEST_CLIENT_SECRET = os.environ.get('AZURE_INGEST_CLIENT_SECRET')
AZURE_INGEST_TENANT_ID = os.environ.get('AZURE_INGEST_TENANT_ID')
AZURE_INGEST_MAILBOX = os.environ.get('AZURE_INGEST_MAILBOX') # z.B. ingest@dms.cloud
Schritt 3: Ingest-Task (dms/tasks.py) Schreibe poll_email_inbox komplett neu zu poll_central_inbox_graph:

Connect: Nutze O365.Account mit client_id und client_secret (Backend Authentication).

Fetch: Lade ungelesene Nachrichten aus der AZURE_INGEST_MAILBOX.

Routing-Logik:

Analysiere die to_recipients (oder cc_recipients) der E-Mail.

Suche nach dem Pattern upload\.(?P<token>[a-f0-9-]+)@.*.

Wichtig: E-Mails können an mehrere Adressen gehen. Prüfe alle Empfänger, bis ein gültiges Tenant-Token gefunden wird.

Lade den Tenant anhand des Tokens.

Verarbeitung:

Nutze with tenant_context(tenant): (aus vorherigem Task).

Rufe process_email_message(message, tenant) auf.

Clean Up (Graph API):

Success: Lösche die E-Mail sofort via API (message.delete()).

Error (Tenant nicht gefunden / Parsing Fehler): Verschiebe die E-Mail in einen Ordner "Quarantine" (message.move('Quarantine')), damit die Inbox leer bleibt.

Hinweis: Stelle sicher, dass die Authentifizierung ohne manuellen Token-Store (token_backend) funktioniert, da es ein reiner Hintergrund-Dienst ist (Daemon).