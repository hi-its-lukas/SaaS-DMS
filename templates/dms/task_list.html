{% extends 'dms/base.html' %}

{% block title %}Aufgaben{% endblock %}
{% block page_title %}Aufgaben{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Aufgaben</h2>
        <span style="color: var(--text-secondary); font-size: 13px;">{{ tasks.paginator.count|default:0 }} Aufgaben</span>
    </div>
    
    <form method="get" class="filters">
        <select name="status" class="form-control" style="width: 180px;">
            <option value="">Alle Status</option>
            {% for value, label in status_choices %}
            <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn">
            <span class="material-icons" style="font-size: 16px;">filter_list</span>
            Filtern
        </button>
        {% if request.GET.status %}
            <a href="{% url 'dms:task_list' %}" class="btn btn-outline">
                <span class="material-icons" style="font-size: 16px;">clear</span>
                Zur체cksetzen
            </a>
        {% endif %}
    </form>
    
    {% if tasks %}
    <table>
        <thead>
            <tr>
                <th>Titel</th>
                <th>Dokument</th>
                <th>Status</th>
                <th>Priorit채t</th>
                <th>Zugewiesen an</th>
                <th>F채lligkeitsdatum</th>
                <th style="text-align: right;">Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>
                    <div style="font-weight: 500;">{{ task.title }}</div>
                    {% if task.description %}
                    <div style="font-size: 12px; color: var(--text-secondary);">{{ task.description|truncatewords:10 }}</div>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'dms:document_detail' task.document.pk %}" style="color: var(--primary); text-decoration: none;">
                        {{ task.document.title|truncatewords:5 }}
                    </a>
                </td>
                <td>
                    <span class="badge badge-{% if task.status == 'COMPLETED' %}active{% elif task.status == 'OPEN' %}unassigned{% else %}archived{% endif %}">
                        {{ task.get_status_display }}
                    </span>
                </td>
                <td>
                    <span class="badge badge-{% if task.priority >= 3 %}error{% elif task.priority == 2 %}unassigned{% else %}active{% endif %}">
                        {{ task.get_priority_display }}
                    </span>
                </td>
                <td style="color: var(--text-secondary);">{{ task.assigned_to.username|default:"-" }}</td>
                <td style="color: var(--text-secondary);">{{ task.due_date|date:"d.m.Y"|default:"-" }}</td>
                <td style="text-align: right;">
                    {% if task.status != 'COMPLETED' %}
                    <button class="btn btn-sm btn-success" onclick="completeTask('{{ task.pk }}')">
                        <span class="material-icons" style="font-size: 14px;">check</span>
                        Erledigen
                    </button>
                    {% else %}
                    <span class="badge badge-active">
                        <span class="material-icons" style="font-size: 12px; vertical-align: middle;">check_circle</span>
                        Erledigt
                    </span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if tasks.has_other_pages %}
    <div class="pagination">
        {% if tasks.has_previous %}
            <a href="?page={{ tasks.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">chevron_left</span>
                Zur체ck
            </a>
        {% endif %}
        
        <span class="current">Seite {{ tasks.number }} von {{ tasks.paginator.num_pages }}</span>
        
        {% if tasks.has_next %}
            <a href="?page={{ tasks.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                Weiter
                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">chevron_right</span>
            </a>
        {% endif %}
    </div>
    {% endif %}
    
    {% else %}
    <div class="empty-state">
        <span class="material-icons">task_alt</span>
        <h3>Keine Aufgaben gefunden</h3>
        <p>Es gibt aktuell keine Aufgaben, die Ihren Filterkriterien entsprechen.</p>
    </div>
    {% endif %}
</div>

<script>
async function completeTask(taskId) {
    try {
        const response = await fetch(`/tasks/${taskId}/complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        alert('Aufgabe konnte nicht abgeschlossen werden');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
