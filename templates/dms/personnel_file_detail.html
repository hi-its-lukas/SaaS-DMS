{% extends 'dms/base.html' %}
{% load dms_extras %}

{% block title %}{{ employee.full_name }} - Personalakte{% endblock %}

{% block extra_css %}
<style>
    .personnel-file-container { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
    
    @media (max-width: 1024px) {
        .personnel-file-container { grid-template-columns: 1fr; }
    }
    
    .employee-sidebar {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow: hidden;
        height: fit-content;
        position: sticky;
        top: 80px;
    }
    
    .employee-header {
        background: linear-gradient(135deg, #007e45 0%, #005a32 100%);
        padding: 24px;
        text-align: center;
        color: white;
    }
    
    .employee-photo {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 4px solid rgba(255,255,255,0.3);
        margin: 0 auto 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.2);
        font-size: 36px;
        font-weight: 600;
    }
    
    .employee-photo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .employee-name {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .employee-title {
        font-size: 14px;
        opacity: 0.9;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 12px;
        text-transform: uppercase;
    }
    
    .status-ACTIVE { background: rgba(255,255,255,0.2); color: white; }
    .status-ONBOARDING { background: #3182ce; color: white; }
    .status-OFFBOARDING { background: #dd6b20; color: white; }
    .status-ARCHIVED { background: #718096; color: white; }
    
    .employee-details {
        padding: 20px;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
    }
    
    .detail-item:last-child { border-bottom: none; }
    
    .detail-label {
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .detail-label .material-icons { font-size: 16px; }
    
    .detail-value {
        font-weight: 500;
        color: var(--text-primary);
        text-align: right;
    }
    
    .reminders-section {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        background: #fffaf0;
    }
    
    .reminders-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--warning);
        text-transform: uppercase;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .reminder-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        font-size: 13px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .reminder-item:last-child { border-bottom: none; }
    
    .reminder-date {
        font-size: 11px;
        color: var(--warning);
        font-weight: 600;
    }
    
    .reminder-overdue { color: var(--error); }
    
    .file-main {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        overflow: hidden;
    }
    
    .file-tabs {
        display: flex;
        border-bottom: 2px solid var(--border);
        background: #f8f9fa;
        overflow-x: auto;
    }
    
    .file-tab {
        padding: 16px 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 14px;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .file-tab:hover {
        color: var(--text-primary);
        background: var(--bg-hover);
    }
    
    .file-tab.active {
        color: #007e45;
        border-bottom-color: #007e45;
        background: white;
    }
    
    .file-tab .material-icons { font-size: 18px; }
    
    .tab-badge {
        background: #007e45;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }
    
    .tab-badge.new {
        background: var(--error);
    }
    
    .tab-content {
        display: none;
        padding: 24px;
        min-height: 400px;
    }
    
    .tab-content.active { display: block; }
    
    .documents-grid {
        display: grid;
        gap: 12px;
    }
    
    .document-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: var(--bg-page);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        transition: all 0.2s;
    }
    
    .document-card:hover {
        border-color: #007e45;
        box-shadow: 0 2px 8px rgba(0,126,69,0.1);
    }
    
    .doc-icon {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .doc-icon.pdf { background: #fee2e2; color: #dc2626; }
    .doc-icon.doc { background: #dbeafe; color: #2563eb; }
    .doc-icon.img { background: #d1fae5; color: #059669; }
    .doc-icon.default { background: var(--bg-hover); color: var(--text-secondary); }
    
    .doc-info { flex: 1; min-width: 0; }
    
    .doc-title {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .doc-meta {
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        gap: 16px;
    }
    
    .doc-new-badge {
        background: var(--error);
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        margin-left: 8px;
    }
    
    .doc-actions {
        display: flex;
        gap: 8px;
    }
    
    .doc-action-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: white;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .doc-action-btn:hover {
        background: #007e45;
        color: white;
        border-color: #007e45;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
    }
    
    .empty-state .material-icons {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    .timeline-item {
        display: flex;
        gap: 16px;
        padding: 16px 0;
        border-bottom: 1px solid var(--border);
    }
    
    .timeline-item:last-child { border-bottom: none; }
    
    .timeline-date {
        width: 80px;
        flex-shrink: 0;
        text-align: center;
    }
    
    .timeline-day {
        font-size: 24px;
        font-weight: 700;
        color: #007e45;
    }
    
    .timeline-month {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
    }
    
    .timeline-content {
        flex: 1;
        background: var(--bg-page);
        padding: 16px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
    }
    
    .timeline-title {
        font-weight: 500;
        margin-bottom: 4px;
    }
    
    .timeline-meta {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 14px;
        margin-bottom: 16px;
    }
    
    .back-link:hover { color: #007e45; }
    
    .category-section { margin-bottom: 24px; }
    
    .category-header-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--bg-page);
        border-radius: var(--radius-md);
        margin-bottom: 12px;
    }
    
    .category-name {
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .category-count {
        background: #007e45;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
    }
</style>
{% endblock %}

{% block content %}
<a href="{% url 'dms:personnel_file_list' %}" class="back-link">
    <span class="material-icons">arrow_back</span>
    Zurück zur Übersicht
</a>

<div class="personnel-file-container">
    <aside class="employee-sidebar">
        <div class="employee-header">
            <div class="employee-photo">
                {% if employee.photo %}
                    <img src="{{ employee.photo.url }}" alt="{{ employee.full_name }}">
                {% else %}
                    {{ employee.first_name|slice:":1" }}{{ employee.last_name|slice:":1" }}
                {% endif %}
            </div>
            <div class="employee-name">{{ employee.full_name }}</div>
            <div class="employee-title">{{ employee.job_title|default:"Mitarbeiter" }}</div>
            <span class="status-badge status-{{ employee.status }}">{{ employee.get_status_display }}</span>
        </div>
        
        <div class="employee-details">
            <div class="detail-item">
                <span class="detail-label">
                    <span class="material-icons">badge</span>
                    Personalnummer
                </span>
                <span class="detail-value">{{ employee.employee_id }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">
                    <span class="material-icons">business</span>
                    Abteilung
                </span>
                <span class="detail-value">{{ employee.department|default:"-" }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">
                    <span class="material-icons">account_balance</span>
                    Kostenstelle
                </span>
                <span class="detail-value">{{ employee.cost_center|default:"-" }}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">
                    <span class="material-icons">event</span>
                    Eintrittsdatum
                </span>
                <span class="detail-value">{{ employee.entry_date|date:"d.m.Y"|default:"-" }}</span>
            </div>
            {% if employee.exit_date %}
            <div class="detail-item">
                <span class="detail-label">
                    <span class="material-icons">event_busy</span>
                    Austrittsdatum
                </span>
                <span class="detail-value">{{ employee.exit_date|date:"d.m.Y" }}</span>
            </div>
            {% endif %}
            <div class="detail-item">
                <span class="detail-label">
                    <span class="material-icons">email</span>
                    E-Mail
                </span>
                <span class="detail-value">{{ employee.email|default:"-" }}</span>
            </div>
        </div>
        
        {% if pending_reminders %}
        <div class="reminders-section">
            <div class="reminders-title">
                <span class="material-icons">notifications_active</span>
                Wiedervorlagen
            </div>
            {% for reminder in pending_reminders %}
            <div class="reminder-item">
                <span class="material-icons" style="font-size: 16px; color: {% if reminder.is_overdue %}var(--error){% else %}var(--warning){% endif %};">
                    {% if reminder.is_overdue %}warning{% else %}schedule{% endif %}
                </span>
                <div style="flex: 1;">
                    <div>{{ reminder.title }}</div>
                    <div class="reminder-date {% if reminder.is_overdue %}reminder-overdue{% endif %}">
                        {{ reminder.due_date|date:"d.m.Y" }}
                        {% if reminder.days_until_due != None %}
                            ({% if reminder.days_until_due < 0 %}{{ reminder.days_until_due|abs }} Tage überfällig{% elif reminder.days_until_due == 0 %}Heute{% else %}in {{ reminder.days_until_due }} Tagen{% endif %})
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </aside>
    
    <main class="file-main">
        <div class="file-tabs">
            <div class="file-tab active" data-tab="stammdaten">
                <span class="material-icons">person</span>
                Stammdaten
            </div>
            <div class="file-tab" data-tab="personal">
                <span class="material-icons">description</span>
                Verträge & Personal
                {% if category_tabs.personal.documents %}
                <span class="tab-badge {% if new_document_counts.personal > 0 %}new{% endif %}">
                    {{ category_tabs.personal.documents|length }}{% if new_document_counts.personal > 0 %} / {{ new_document_counts.personal }} neu{% endif %}
                </span>
                {% endif %}
            </div>
            <div class="file-tab" data-tab="salary">
                <span class="material-icons">payments</span>
                Lohn & Gehalt
                {% if category_tabs.salary.documents %}
                <span class="tab-badge {% if new_document_counts.salary > 0 %}new{% endif %}">
                    {{ category_tabs.salary.documents|length }}{% if new_document_counts.salary > 0 %} / {{ new_document_counts.salary }} neu{% endif %}
                </span>
                {% endif %}
            </div>
            <div class="file-tab" data-tab="absence">
                <span class="material-icons">medical_services</span>
                Krankheit & Abwesenheit
                {% if category_tabs.absence.documents %}
                <span class="tab-badge {% if new_document_counts.absence > 0 %}new{% endif %}">
                    {{ category_tabs.absence.documents|length }}{% if new_document_counts.absence > 0 %} / {{ new_document_counts.absence }} neu{% endif %}
                </span>
                {% endif %}
            </div>
            <div class="file-tab" data-tab="timeline">
                <span class="material-icons">timeline</span>
                Timeline
                {% if all_documents %}
                <span class="tab-badge">{{ all_documents|length }}</span>
                {% endif %}
            </div>
        </div>
        
        <div class="tab-content active" id="tab-stammdaten">
            <h3 style="margin-bottom: 20px;">Stammdaten</h3>
            
            <div class="card" style="margin-bottom: 0;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
                    <div>
                        <h4 style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 16px;">Persönliche Daten</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px 0; color: var(--text-secondary);">Vorname</td>
                                <td style="padding: 8px 0; font-weight: 500;">{{ employee.first_name }}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: var(--text-secondary);">Nachname</td>
                                <td style="padding: 8px 0; font-weight: 500;">{{ employee.last_name }}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: var(--text-secondary);">Position</td>
                                <td style="padding: 8px 0; font-weight: 500;">{{ employee.job_title|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: var(--text-secondary);">E-Mail</td>
                                <td style="padding: 8px 0; font-weight: 500;">{{ employee.email|default:"-" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 16px;">Organisatorische Daten</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px 0; color: var(--text-secondary);">Personalnummer</td>
                                <td style="padding: 8px 0; font-weight: 500;">{{ employee.employee_id }}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: var(--text-secondary);">Abteilung</td>
                                <td style="padding: 8px 0; font-weight: 500;">{{ employee.department|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: var(--text-secondary);">Kostenstelle</td>
                                <td style="padding: 8px 0; font-weight: 500;">{{ employee.cost_center|default:"-" }}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; color: var(--text-secondary);">Status</td>
                                <td style="padding: 8px 0;">
                                    <span class="badge badge-{% if employee.status == 'ACTIVE' %}success{% elif employee.status == 'ARCHIVED' %}default{% else %}warning{% endif %}">
                                        {{ employee.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border);">
                
                <h4 style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 16px;">Beschäftigungszeitraum</h4>
                <div style="display: flex; gap: 40px;">
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px;">Eintrittsdatum</div>
                        <div style="font-size: 18px; font-weight: 600; color: #007e45;">{{ employee.entry_date|date:"d.m.Y"|default:"Nicht angegeben" }}</div>
                    </div>
                    {% if employee.exit_date %}
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px;">Austrittsdatum</div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--error);">{{ employee.exit_date|date:"d.m.Y" }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% for tab_key, tab_data in category_tabs.items %}
        <div class="tab-content" id="tab-{{ tab_key }}">
            <h3 style="margin-bottom: 20px;">{{ tab_data.name }}</h3>
            
            {% if tab_data.documents %}
            <div class="documents-grid">
                {% for doc in tab_data.documents %}
                <div class="document-card">
                    <div class="doc-icon {% if doc.file_extension == '.pdf' %}pdf{% elif doc.file_extension in '.doc,.docx' %}doc{% elif doc.file_extension in '.jpg,.png,.gif' %}img{% else %}default{% endif %}">
                        <span class="material-icons">
                            {% if doc.file_extension == '.pdf' %}picture_as_pdf{% elif doc.file_extension in '.doc,.docx' %}article{% elif doc.file_extension in '.jpg,.png,.gif' %}image{% else %}insert_drive_file{% endif %}
                        </span>
                    </div>
                    <div class="doc-info">
                        <div class="doc-title">
                            {{ doc.title }}
                            {% if doc.is_new %}<span class="doc-new-badge">NEU</span>{% endif %}
                        </div>
                        <div class="doc-meta">
                            <span>{{ doc.original_filename }}</span>
                            <span>{{ doc.created_at|date:"d.m.Y" }}</span>
                            {% if doc.period_year and doc.period_month %}
                            <span style="color: #007e45; font-weight: 500;">{{ doc.period_month|stringformat:"02d" }}/{{ doc.period_year }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="doc-actions">
                        <a href="{% url 'dms:document_view' pk=doc.pk %}" class="doc-action-btn" title="Ansehen">
                            <span class="material-icons" style="font-size: 18px;">visibility</span>
                        </a>
                        <a href="{% url 'dms:document_download' pk=doc.pk %}" class="doc-action-btn" title="Download">
                            <span class="material-icons" style="font-size: 18px;">download</span>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <span class="material-icons">folder_open</span>
                <div>Noch keine Dokumente in dieser Kategorie</div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        
        <div class="tab-content" id="tab-timeline">
            <h3 style="margin-bottom: 20px;">Alle Dokumente (chronologisch)</h3>
            
            {% if all_documents %}
            <div class="timeline">
                {% for doc in all_documents %}
                <div class="timeline-item">
                    <div class="timeline-date">
                        <div class="timeline-day">{{ doc.created_at|date:"d" }}</div>
                        <div class="timeline-month">{{ doc.created_at|date:"M Y" }}</div>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-title">
                            <a href="{% url 'dms:document_detail' pk=doc.pk %}" style="color: inherit; text-decoration: none;">
                                {{ doc.title }}
                            </a>
                        </div>
                        <div class="timeline-meta">
                            {{ doc.original_filename }} &bull; 
                            {{ doc.get_source_display }} &bull;
                            {% if doc.document_type %}{{ doc.document_type.name }}{% else %}Nicht klassifiziert{% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <span class="material-icons">history</span>
                <div>Noch keine Dokumente vorhanden</div>
            </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.file-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.file-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        this.classList.add('active');
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
    });
});
</script>
{% endblock %}
